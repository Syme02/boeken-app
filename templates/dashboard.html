{% extends "base.html" %}

{% block title %}Instellingen - Boeken Applicatie{% endblock %}

{% block content %}
  <div class="container mx-auto max-w-7xl p-4 flex-1 flex flex-col">
    <!-- Flash messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="space-y-2 mb-4">
          {% for category, message in messages %}
            <div class="p-3 rounded-lg text-white shadow-md"
                 style="background-color: {% if category=='success' %}#16a34a{% elif category=='error' %}#dc2626{% else %}#2563eb{% endif %};">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- Zoeksectie -->
    <div class="card rounded-xl shadow-sm p-6 flex-1">
      <h2 class="text-2xl font-bold mb-4">Zoeken{% if edit_book_data %} of Boek Bewerken{% else %}{% if is_admin %} of Boek Toevoegen{% endif %}{% endif %}</h2>

      <!-- Boekkaft -->
      <div id="coverSection" class="hidden mb-6">
        <h3 class="text-lg font-semibold mb-2">Boekkaft</h3>
        <img id="coverImage" src="" alt="Boekkaft" class="max-w-xs rounded shadow-md" />
      </div> 

      <!-- Zoekformulier -->
      <form id="searchForm" method="POST" class="mb-6">
        <input type="hidden" name="action" id="form_action" value="search">
        <input type="hidden" name="book_id" id="book_id" value="{{ edit_book_data.book_id if edit_book_data else '' }}">
        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4">
        {% for field in ['titel', 'auteur_voornaam', 'auteur_achternaam', 'genre', 'uitgeverij', 'isbn', 'reeks_nr', 'serie', 'staat', 'taal', 'gesigneerd', 'gelezen', 'bindwijze', 'edition'] %}
            <div class="flex flex-col">
                <label for="{{ field }}" class="block text-sm font-medium">{{ field.replace('_', ' ').title() }}</label>
                <input type="text" id="{{ field }}" name="{{ field }}" 
                       value="{{ edit_book_data[field] if edit_book_data and field in edit_book_data else filters[field] if field in filters else '' }}" 
                       class="mt-1 block w-full rounded-md shadow-sm input-base px-3 py-2" 
                       placeholder="{{ {
                           'titel': 'Titel van het boek',
                           'auteur_voornaam': 'Auteur voornaam',
                           'auteur_achternaam': 'Auteur achternaam',
                           'genre': 'Genre van het boek',
                           'uitgeverij': 'Naam van uitgeverij',
                           'isbn': 'isbn van het boek',
                           'reeks_nr': 'Reeks nummer van boek',
                           'serie': 'vb. stanalone, serie, trilogie, ...',
                           'staat': 'Staat van het boek',
                           'taal': 'Taal van het boek',
                           'gesigneerd': 'Ja / Neen',
                           'gelezen': 'Ja / Neen ',
                           'bindwijze': 'bv. Paperback, Hardcover',
                           'edition': 'bv. First edition'
                       }[field] }}" />
            </div>
        {% endfor %}
          <!-- Aankoop Locatie -->
          <div class="flex flex-col">
            <label for="land" class="block text-sm font-medium">Aankoop Locatie (Stad of Land)</label>
            <input type="text" id="land" name="land" value="{{ edit_book_data.land if edit_book_data else filters.land if 'land' in filters else '' }}" class="mt-1 block w-full rounded-md shadow-sm input-base px-3 py-2" placeholder="bijv. Antwerpen, Belgi√´" />
          </div>
          <!-- Prijs -->
          <div class="flex flex-col">
            <label class="block text-sm font-medium">Prijs</label>
            <div class="flex space-x-2">
              <input type="number" step="0.01" min="0" id="min_prijs" name="min_prijs"
                     value="{{ (edit_book_data.min_prijs if edit_book_data else (filters.min_prijs | default('', true))) }}"
                     class="mt-1 block w-1/2 rounded-md shadow-sm input-base px-3 py-2" placeholder="Min" />
              <input type="number" step="0.01" min="0" id="max_prijs" name="max_prijs"
                     value="{{ filters.max_prijs | default('', true) }}"
                     class="mt-1 block w-1/2 rounded-md shadow-sm input-base px-3 py-2" placeholder="Max" />
            </div>
          </div>
          <!-- Pagina's -->
          <div class="flex flex-col">
            <label class="block text-sm font-medium">Pagina's</label>
            <div class="flex space-x-2">
              <input type="number" min="0" id="min_paginas" name="min_paginas"
                     value="{{ (edit_book_data.min_paginas if edit_book_data else (filters.min_paginas | default('', true))) }}"
                     class="mt-1 block w-1/2 rounded-md shadow-sm input-base px-3 py-2" placeholder="Min" />
              <input type="number" min="0" id="max_paginas" name="max_paginas"
                     value="{{ filters.max_paginas | default('', true) }}"
                     class="mt-1 block w-1/2 rounded-md shadow-sm input-base px-3 py-2" placeholder="Max" />
            </div>
          </div>
        </div>
        <div class="flex flex-wrap gap-3 mt-4">
          <button type="submit" onclick="document.getElementById('form_action').value='search'" class="px-4 py-2 rounded-md btn-primary">Zoeken</button>
          {% if is_admin %}
            {% if edit_book_data %}
              <button type="submit" onclick="document.getElementById('form_action').value='edit'" class="px-4 py-2 rounded-md btn-primary">Bijwerken</button>
            {% else %}
              <button type="submit" id="toevoegButton" onclick="document.getElementById('form_action').value='add'" class="px-4 py-2 rounded-md btn-primary">Toevoegen</button>
            {% endif %}
            <!-- Knoppen standaard hidden -->
            <button type="button" id="editButton" class="px-4 py-2 rounded-md btn-primary hidden" data-book-id="">Bewerken</button>
            <button type="button" id="deleteButton" class="px-4 py-2 rounded-md bg-red-600 text-white hover:bg-red-700 hidden" data-book-id="">Verwijderen</button>
            <button type="button" onclick="window.location.href='{{ url_for('dashboard') }}'" class="px-4 py-2 rounded-md bg-gray-500 text-white hover:bg-gray-600">Annuleren</button>
          {% endif %}
        </div>
      </form>

      <!-- Overzicht -->
      <h2 class="text-2xl font-bold mb-2">Boeken</h2>
      <p class="mb-4 text-sm" style="color: var(--muted);">
        Totaal aantal boeken: <span id="totalBooks">{{ books | length }}</span>
        | Totaalprijs: ‚Ç¨<span id="totalPrice">{{ total_price | round(2) }}</span>
        | Totaal aantal pagina's: <span id="totalPages">{{ total_pages }}</span>
      </p>

      <!-- Tabel -->
      <div class="overflow-x-auto rounded-lg shadow-sm border" style="border-color: var(--border-color);">
        <table class="min-w-full divide-y" style="border-color: var(--border-color);">
          <!-- HEAD -->
          <thead style="background-color: var(--primary-color); color: #ffffff;">
            <tr>
              <th class="px-3 py-2 text-left text-sm font-semibold">‚ô•</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">Nr</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">Titel</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">Auteur</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">Genre</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">Prijs (‚Ç¨)</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">Pagina's</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">Bindwijze</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">Editie</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">ISBN</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">Reeks Nr</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">Uitgeverij</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">Serie</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">Staat</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">Taal</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">Gesigneerd</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">Gelezen</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">Aankoop Locatie (Stad of Land)</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">Acties</th>
            </tr>
          </thead>
          <!-- BODY -->
<tbody id="booksTable" class="divide-y" style="border-color: var(--border-color);">
  {% for book in books %}
    <tr style="background-color: {{ 'var(--row-even)' if loop.index % 2 == 0 else 'var(--row-odd)' }};">
      <!-- Like-knop -->
      <td class="px-3 py-2 text-sm">
        <button onclick="toggleLike({{ book[0] }})" class="like-btn">
          {% if session.user_id and book[0] in user_likes %}
            ‚ù§Ô∏è
          {% else %}
            ü§ç
          {% endif %}
        </button>
      </td>
      <td class="px-3 py-2 text-sm">{{ loop.index }}</td>
      <td class="px-3 py-2 text-sm">{{ book[1] }}</td>
      <td class="px-3 py-2 text-sm">{{ book[2] }} {{ book[3] }}</td>
      <td class="px-3 py-2 text-sm">{{ book[4] }}</td>
      <td class="px-3 py-2 text-sm">{{ book[5] | round(2) }}</td>
      <td class="px-3 py-2 text-sm">{{ book[6] }}</td>
      <td class="px-3 py-2 text-sm">{{ book[7] }}</td>
      <td class="px-3 py-2 text-sm">{{ book[8] }}</td>
      <td class="px-3 py-2 text-sm">{{ book[9] }}</td>
      <td class="px-3 py-2 text-sm">{{ book[10] }}</td>
      <td class="px-3 py-2 text-sm">{{ book[11] }}</td>
      <td class="px-3 py-2 text-sm">{{ book[12] }}</td>
      <td class="px-3 py-2 text-sm">{{ book[13] }}</td>
      <td class="px-3 py-2 text-sm">{{ book[14] }}</td>
      <td class="px-3 py-2 text-sm">{{ book[15] }}</td>
      <td class="px-3 py-2 text-sm">{{ book[16] }}</td>
      <td class="px-3 py-2 text-sm">{{ book[18] }}</td>
    </tr>
  {% endfor %}
</tbody>
        </table>
      </div>
    </div>
  </div>
{% endblock %}
{% block scripts %}
  <script>
    const searchForm = document.getElementById('searchForm');
    const inputs = searchForm.querySelectorAll('input');
    const coverSection = document.getElementById('coverSection');
    const coverImage = document.getElementById('coverImage');
    const totalBooks = document.getElementById('totalBooks');
    const totalPriceEl = document.getElementById('totalPrice');
    const totalPagesEl = document.getElementById('totalPages');
    let debounceTimeout; 
    let coverDebounceTimeout;
    let isEditing = {{ 'true' if edit_book_data else 'false' }};


    // Flash messages dynamisch tonen
    function showFlashMessage(message, category) {
      const flashContainer = document.querySelector('.flash-container') || (() => { 
        const el = document.createElement('div'); 
        el.className = 'flash-container space-y-2 mb-4'; 
        searchForm.parentNode.insertBefore(el, searchForm); 
        return el; 
      })();
      const flashMessage = document.createElement('div');
      flashMessage.className = `p-3 rounded-lg text-white shadow-md ${category === 'success' ? 'bg-green-600' : category === 'error' ? 'bg-red-600' : 'bg-blue-600'}`;
      flashMessage.textContent = message; 
      flashContainer.appendChild(flashMessage);
      setTimeout(() => flashMessage.remove(), 5000);
    }

function fetchCover(titel, isbn) {
    if (!titel && !isbn) { coverSection.classList.add('hidden'); return; }
    const body = new URLSearchParams({ titel: titel || '', isbn: isbn || '' });
    fetch('/fetch_cover', { method: 'POST', body })
        .then(r => r.json())
        .then(data => {
            showFlashMessage(data.message, data.category);
            if (data.cover_url) {
                coverImage.src = data.cover_url;
                coverSection.classList.remove('hidden');
            } else {
                coverSection.classList.add('hidden');
            }
        })
        .catch(() => showFlashMessage('Fout bij ophalen boekkaft.', 'error'));
}

    // Boek liken/unliken
    function toggleLike(bookId) {
      fetch(`/like/${bookId}`, { method: 'POST' })
        .then(response => {
          if (response.status === 401) {
            alert("Je moet inloggen om boeken te liken!");
            return null;
          }
          return response.json();
        })
        .then(data => {
          if (data && data.success) {
            const btn = document.querySelector(`button[onclick="toggleLike(${bookId})"]`);
            btn.innerHTML = data.liked ? "‚ù§Ô∏è" : "ü§ç";
          }
        })
        .catch(err => console.error(err));
    }

    // Helpers
    function formatCurrency(value) { 
      try { 
        const v = Number(value) || 0; 
        return v.toFixed(2); 
      } catch { return '0.00'; } 
    }

    // Boekenlijst dynamisch updaten (AJAX search)
    function updateBooks() {
      const formData = {};
      inputs.forEach(input => {
        const v = input.value.trim();
        if (v && input.name !== 'action' && input.name !== 'book_id') formData[input.name] = v;
      });

      fetch('/search', { 
        method: 'POST', 
        headers: { 'Content-Type': 'application/json' }, 
        body: JSON.stringify(formData)
      })
        .then(r => r.json())
        .then(books => {
          const tbody = document.getElementById('booksTable'); 
          tbody.innerHTML = '';
          let sumPrice = 0; 
          let sumPages = 0;

          books.forEach((book, i) => {
            sumPrice += Number(book.prijs) || 0; 
            sumPages += Number(book.paginas) || 0;

            const tr = document.createElement('tr');
            tr.style.backgroundColor = (i % 2 === 0) ? 'var(--row-even)' : 'var(--row-odd)';

            tr.innerHTML = `
              <td class='px-3 py-2 text-sm'>
                <button onclick="toggleLike(${book.id})" class="like-btn">
                  ${book.liked ? "‚ù§Ô∏è" : "ü§ç"}
                </button>
              </td>
              <td class='px-3 py-2 text-sm'>${i + 1}</td>
              <td class='px-3 py-2 text-sm'>${book.titel || ''}</td>
              <td class='px-3 py-2 text-sm'>${(book.auteur_voornaam || '')} ${(book.auteur_achternaam || '')}</td>
              <td class='px-3 py-2 text-sm'>${book.genre || ''}</td>
              <td class='px-3 py-2 text-sm'>${formatCurrency(book.prijs)}</td>
              <td class='px-3 py-2 text-sm'>${book.paginas || ''}</td>
              <td class='px-3 py-2 text-sm'>${book.bindwijze || ''}</td>
              <td class='px-3 py-2 text-sm'>${book.edition || ''}</td>
              <td class='px-3 py-2 text-sm'>${book.isbn || ''}</td>
              <td class='px-3 py-2 text-sm'>${book.reeks_nr || ''}</td>
              <td class='px-3 py-2 text-sm'>${book.uitgeverij || ''}</td>
              <td class='px-3 py-2 text-sm'>${book.serie || ''}</td>
              <td class='px-3 py-2 text-sm'>${book.staat || ''}</td>
              <td class='px-3 py-2 text-sm'>${book.taal || ''}</td>
              <td class='px-3 py-2 text-sm'>${book.gesigneerd || ''}</td>
              <td class='px-3 py-2 text-sm'>${book.gelezen || ''}</td>
              <td class='px-3 py-2 text-sm'>${book.land || ''}</td>
              <td class='px-3 py-2 text-sm'>
                ${book.is_admin ? `
                  <a href='/edit/${book.id}' class='link-primary'>Bewerken</a> |
                  <form action='/delete/${book.id}' method='POST' style='display:inline;'>
                    <button type='submit' class='link-primary' onclick='return confirm("Weet je zeker dat je dit boek wilt verwijderen?")'>Verwijderen</button>
                  </form>` 
                : `<span class='text-gray-500'>Geen rechten</span>`}
              </td>`;
            tbody.appendChild(tr);
          });

          // Totals updaten
          totalBooks.textContent = books.length;
          totalPriceEl.textContent = formatCurrency(sumPrice);
          totalPagesEl.textContent = sumPages;

          // Boekkaft tonen bij 1 resultaat
          if (books.length === 1 && !isEditing) {
          const book = books[0];

          // Boekkaft tonen
          clearTimeout(coverDebounceTimeout);
          coverDebounceTimeout = setTimeout(() => fetchCover(book.titel, book.isbn), 500);

          // Toon bewerk- en verwijderknoppen boven het formulier
          const editBtn = document.getElementById('editButton');
          const deleteBtn = document.getElementById('deleteButton');
          editBtn.dataset.bookId = book.id;
          deleteBtn.dataset.bookId = book.id;
          editBtn.classList.remove('hidden');
          deleteBtn.classList.remove('hidden');
          document.getElementById('toevoegButton').classList.add('hidden');
      } else {
          coverSection.classList.add('hidden');

          // Verberg de knoppen als meerdere boeken of als we aan het bewerken zijn
          document.getElementById('toevoegButton').classList.remove('hidden');
          document.getElementById('editButton').classList.add('hidden');
          document.getElementById('deleteButton').classList.add('hidden');
      }


        })
        .catch(() => showFlashMessage('Fout bij zoeken.', 'error'));
    }

    // Event listeners
    inputs.forEach(input => 
      input.addEventListener('input', () => {
        clearTimeout(debounceTimeout); 
        debounceTimeout = setTimeout(updateBooks, 300);
      })
    );

    searchForm.addEventListener('submit', (e) => {
      if (e.submitter && document.getElementById('form_action').value === 'search') {
        e.preventDefault();
        const fd = new FormData(searchForm);
        fetchCover((fd.get('titel') || '').trim(), (fd.get('isbn') || '').trim());
        updateBooks();
      }
    });

    document.getElementById('editButton').addEventListener('click', () => {
  const bookId = document.getElementById('editButton').dataset.bookId;
  if (bookId) {
    isEditing = true;  // Zet bewerkmodus aan
    window.location.href = `/edit/${bookId}`;
  }
});


    function selectBook(bookId) {
  document.getElementById('editButton').dataset.bookId = bookId;
  document.getElementById('deleteButton').dataset.bookId = bookId;
  //document.getElementById('editButton').classList.remove('hidden');
  document.getElementById('deleteButton').classList.remove('hidden');
}


document.getElementById('editButton').addEventListener('click', () => {
  const bookId = document.getElementById('editButton').dataset.bookId;
  if (bookId) {
    window.location.href = `/edit/${bookId}`;
  }
});

document.getElementById('deleteButton').addEventListener('click', () => {
  const bookId = document.getElementById('deleteButton').dataset.bookId;
  if (bookId && confirm("Weet je zeker dat je dit boek wilt verwijderen?")) {
    fetch(`/delete/${bookId}`, { method: 'POST' })
      .then(() => location.reload())
      .catch(() => alert("Fout bij verwijderen."));
  }
});


  </script>
{% endblock %}