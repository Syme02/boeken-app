<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Boeken Applicatie</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <style>
    :root {
      --primary-color: {{ settings.color }};
      --background-color: {{ '#1f2937' if settings.dark_mode else '#ffffff' }};
      --text-color: {{ '#f9fafb' if settings.dark_mode else '#111827' }};
      --card-bg: {{ '#111827' if settings.dark_mode else '#ffffff' }};
      --row-odd: {{ '#0f172a' if settings.dark_mode else '#ffffff' }};
      --row-even: {{ '#111827' if settings.dark_mode else '#f9fafb' }};
      --muted: {{ '#9ca3af' if settings.dark_mode else '#6b7280' }};
      --border-color: {{ '#374151' if settings.dark_mode else '#e5e7eb' }};
      --focus-ring: {{ settings.color }};
    }
    html, body { height: 100%; }
    body { background-color: var(--background-color); color: var(--text-color); }
    .card { background-color: var(--card-bg); border: 1px solid var(--border-color); }
    .input-base { border: 1px solid var(--border-color); background-color: var(--background-color); color: var(--text-color); }
    .input-base:focus { outline: none; box-shadow: 0 0 0 3px rgba(59,130,246,0); border-color: var(--focus-ring); }
    .btn-primary { background-color: var(--primary-color); color: #fff; }
    .btn-primary:hover { filter: brightness(0.95); }
    .link-primary { color: var(--primary-color); }
    .link-primary:hover { text-decoration: underline; }
    thead th { white-space: nowrap; }
    thead { position: sticky; top: 0; z-index: 10; }
  </style>
</head>
<body class="min-h-screen flex flex-col">
<header class="bg-white dark:bg-gray-800 shadow">
  <div class="container mx-auto max-w-7xl p-4 flex justify-between items-center">
    <h1 class="text-2xl font-bold">Boeken Applicatie</h1>
    <nav class="flex space-x-4 items-center">
      <a href="{{ url_for('index') }}" class="px-4 py-2 rounded-md font-medium link-primary">Boeken Zoeken</a>
      <a href="{{ url_for('statistics') }}" class="px-4 py-2 rounded-md font-medium link-primary">Grafieken</a>
      {% if is_admin %}
        <a href="{{ url_for('settings') }}" class="px-4 py-2 rounded-md font-medium link-primary">Instellingen</a>
      {% endif %}
      {% if session.username %}
        <span class="text-sm">Ingelogd als: {{ session.username }} ({{ session.role }})</span>
        <a href="{{ url_for('logout') }}" class="px-4 py-2 rounded-md btn-primary">Uitloggen</a>
      {% else %}
        <a href="{{ url_for('login') }}" class="px-4 py-2 rounded-md btn-primary">Inloggen</a>
        <a href="{{ url_for('register') }}" class="px-4 py-2 rounded-md btn-primary">Registreren</a>
      {% endif %}
    </nav>
  </div>
</header>

  <div class="container mx-auto max-w-7xl p-4 flex-1 flex flex-col">
    <!-- Flash messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="space-y-2 mb-4">
          {% for category, message in messages %}
            <div class="p-3 rounded-lg text-white shadow-md"
                 style="background-color: {% if category=='success' %}#16a34a{% elif category=='error' %}#dc2626{% else %}#2563eb{% endif %};">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- Zoeksectie -->
    <div class="card rounded-xl shadow-sm p-6 flex-1">
      <h2 class="text-2xl font-bold mb-4">Zoeken{% if edit_book_data %} of Boek Bewerken{% else %} of Boek Toevoegen{% endif %}</h2>

      <!-- Boekkaft -->
      <div id="coverSection" class="hidden mb-6">
        <h3 class="text-lg font-semibold mb-2">Boekkaft</h3>
        <img id="coverImage" src="" alt="Boekkaft" class="max-w-xs rounded shadow-md" />
      </div>

      <!-- Zoek-, toevoeg- en bewerkformulier -->
      <form id="searchForm" method="POST" class="mb-6">
        <input type="hidden" name="action" id="form_action" value="search">
        <input type="hidden" name="book_id" id="book_id" value="{{ edit_book_data.book_id if edit_book_data else '' }}">
        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4">
          {% for field in ['titel', 'auteur_voornaam', 'auteur_achternaam', 'genre', 'prijs', 'paginas', 'uitgeverij', 'isbn', 'serie', 'staat', 'taal', 'gesigneerd', 'gelezen', 'bindwijze', 'edition'] %}
            <div>
              <label for="{{ field }}" class="block text-sm font-medium">{{ field.replace('_', ' ').title() }}</label>
              <input type="text" id="{{ field }}" name="{{ field }}" value="{{ edit_book_data[field] if edit_book_data and field in edit_book_data else filters[field] if field in filters else '' }}" class="mt-1 block w-full rounded-md shadow-sm input-base px-3 py-2" {% if not is_admin and field not in ['titel', 'auteur_voornaam', 'auteur_achternaam', 'genre', 'uitgeverij', 'isbn', 'serie', 'staat', 'taal', 'gesigneerd', 'gelezen', 'bindwijze', 'edition'] %}disabled{% endif %} />
            </div>
          {% endfor %}
        </div>
        <div class="flex flex-wrap gap-3 mt-4">
          <button type="submit" onclick="document.getElementById('form_action').value='search'" class="px-4 py-2 rounded-md btn-primary">Zoeken</button>
          {% if is_admin %}
            {% if edit_book_data %}
              <button type="submit" onclick="document.getElementById('form_action').value='edit'" class="px-4 py-2 rounded-md btn-primary">Bijwerken</button>
            {% else %}
              <button type="submit" onclick="document.getElementById('form_action').value='add'" class="px-4 py-2 rounded-md btn-primary">Toevoegen</button>
            {% endif %}
          {% endif %}
          <button type="button" onclick="window.location.href='{{ url_for('index') }}'" class="px-4 py-2 rounded-md bg-gray-500 text-white hover:bg-gray-600">Annuleren</button>
        </div>
      </form>

      <!-- Overzicht -->
      <h2 class="text-2xl font-bold mb-2">Boeken</h2>
      <p class="mb-4 text-sm" style="color: var(--muted);">
        Totaal aantal boeken: <span id="totalBooks">{{ books | length }}</span>
        | Totaalprijs: €<span id="totalPrice">{{ total_price | round(2) }}</span>
        | Totaal aantal pagina's: <span id="totalPages">{{ total_pages }}</span>
      </p>

      <!-- Tabel -->
      <div class="overflow-x-auto rounded-lg shadow-sm border" style="border-color: var(--border-color);">
        <table class="min-w-full divide-y" style="border-color: var(--border-color);">
          <thead style="background-color: var(--primary-color); color: #ffffff;">
            <tr>
              <th class="px-3 py-2 text-left text-sm font-semibold">Nr</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">Titel</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">Auteur</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">Genre</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">Prijs (€)</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">Pagina's</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">Bindwijze</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">Editie</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">ISBN</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">Reeks Nr</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">Uitgeverij</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">Serie</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">Staat</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">Taal</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">Gesigneerd</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">Gelezen</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">Acties</th>
            </tr>
          </thead>
          <tbody id="booksTable" class="divide-y" style="border-color: var(--border-color);">
            {% for book in books %}
              <tr style="background-color: {{ 'var(--row-even)' if loop.index % 2 == 0 else 'var(--row-odd)' }};">
                <td class="px-3 py-2 text-sm">{{ loop.index }}</td>
                <td class="px-3 py-2 text-sm">{{ book[1] }}</td>
                <td class="px-3 py-2 text-sm">{{ book[2] }} {{ book[3] }}</td>
                <td class="px-3 py-2 text-sm">{{ book[4] }}</td>
                <td class="px-3 py-2 text-sm">{{ book[5] | round(2) }}</td>
                <td class="px-3 py-2 text-sm">{{ book[6] }}</td>
                <td class="px-3 py-2 text-sm">{{ book[7] }}</td>
                <td class="px-3 py-2 text-sm">{{ book[8] }}</td>
                <td class="px-3 py-2 text-sm">{{ book[9] }}</td>
                <td class="px-3 py-2 text-sm">{{ book[10] }}</td>
                <td class="px-3 py-2 text-sm">{{ book[11] }}</td>
                <td class="px-3 py-2 text-sm">{{ book[12] }}</td>
                <td class="px-3 py-2 text-sm">{{ book[13] }}</td>
                <td class="px-3 py-2 text-sm">{{ book[14] }}</td>
                <td class="px-3 py-2 text-sm">{{ book[15] }}</td>
                <td class="px-3 py-2 text-sm">{{ book[16] }}</td>
                <td class="px-3 py-2 text-sm">
                  {% if is_admin %}
                    <a href="{{ url_for('edit_book', book_id=book[0]) }}" class="link-primary">Bewerken</a> |
                    <form action="{{ url_for('delete_book', book_id=book[0]) }}" method="POST" style="display:inline;">
                      <button type="submit" class="link-primary" onclick="return confirm('Weet je zeker dat je dit boek wilt verwijderen?')">Verwijderen</button>
                    </form>
                  {% else %}
                    <span class="text-gray-500">Geen rechten</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <p class="text-center mt-6 italic" style="color: var(--muted);">Versie 1.4.7</p>
  </div>

  <script>
    const searchForm = document.getElementById('searchForm');
    const inputs = searchForm.querySelectorAll('input');
    const coverSection = document.getElementById('coverSection');
    const coverImage = document.getElementById('coverImage');
    const totalBooks = document.getElementById('totalBooks');
    const totalPriceEl = document.getElementById('totalPrice');
    const totalPagesEl = document.getElementById('totalPages');
    let debounceTimeout; let coverDebounceTimeout;

    function showFlashMessage(message, category) {
      const flashContainer = document.querySelector('.flash-container') || (() => { const el=document.createElement('div'); el.className='flash-container space-y-2 mb-4'; searchForm.insertAdjacentElement('beforebegin', el); return el; })();
      const flashMessage = document.createElement('div');
      flashMessage.className = `p-3 rounded-lg text-white shadow-md ${category==='success'?'bg-green-600':category==='error'?'bg-red-600':'bg-blue-600'}`;
      flashMessage.textContent = message; flashContainer.appendChild(flashMessage);
      setTimeout(() => flashMessage.remove(), 5000);
    }

    function fetchCover(titel, isbn) {
      if (!titel && !isbn) { coverSection.classList.add('hidden'); return; }
      const body = new URLSearchParams({ titel: titel || '', isbn: isbn || '' });
      fetch('/fetch_cover', { method:'POST', body })
        .then(r=>r.json())
        .then(data=>{
          showFlashMessage(data.message, data.category);
          if (data.cover_url) { coverImage.src = data.cover_url; coverSection.classList.remove('hidden'); }
          else { coverSection.classList.add('hidden'); }
        })
        .catch(()=> showFlashMessage('Fout bij ophalen boekkaft.','error'));
    }

    function formatCurrency(value){ try{ const v=Number(value)||0; return v.toFixed(2); }catch{ return '0.00'; } }

    function updateBooks() {
      const formData = {}; inputs.forEach(input => { const v=input.value.trim(); if(v && input.name !== 'action' && input.name !== 'book_id') formData[input.name]=v; });
      fetch('/search',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(formData)})
        .then(r=>r.json())
        .then(books=>{
          const tbody=document.getElementById('booksTable'); tbody.innerHTML='';
          let sumPrice=0; let sumPages=0;
          books.forEach((book,i)=>{
            sumPrice += Number(book.prijs)||0; sumPages += Number(book.paginas)||0;
            const tr=document.createElement('tr');
            tr.style.backgroundColor = (i%2===0)?'var(--row-even)':'var(--row-odd)';
            tr.innerHTML=`
              <td class='px-3 py-2 text-sm'>${i+1}</td>
              <td class='px-3 py-2 text-sm'>${book.titel||''}</td>
              <td class='px-3 py-2 text-sm'>${(book.auteur_voornaam||'')} ${(book.auteur_achternaam||'')}</td>
              <td class='px-3 py-2 text-sm'>${book.genre||''}</td>
              <td class='px-3 py-2 text-sm'>${formatCurrency(book.prijs)}</td>
              <td class='px-3 py-2 text-sm'>${book.paginas||''}</td>
              <td class='px-3 py-2 text-sm'>${book.bindwijze||''}</td>
              <td class='px-3 py-2 text-sm'>${book.edition||''}</td>
              <td class='px-3 py-2 text-sm'>${book.isbn||''}</td>
              <td class='px-3 py-2 text-sm'>${book.reeks_nr||''}</td>
              <td class='px-3 py-2 text-sm'>${book.uitgeverij||''}</td>
              <td class='px-3 py-2 text-sm'>${book.serie||''}</td>
              <td class='px-3 py-2 text-sm'>${book.staat||''}</td>
              <td class='px-3 py-2 text-sm'>${book.taal||''}</td>
              <td class='px-3 py-2 text-sm'>${book.gesigneerd||''}</td>
              <td class='px-3 py-2 text-sm'>${book.gelezen||''}</td>
              <td class='px-3 py-2 text-sm'>
                {% if is_admin %}
                  <a href='/edit/${book.id}' class='link-primary'>Bewerken</a> |
                  <form action='/delete/${book.id}' method='POST' style='display:inline;'>
                    <button type='submit' class='link-primary' onclick='return confirm("Weet je zeker dat je dit boek wilt verwijderen?")'>Verwijderen</button>
                  </form>
                {% else %}
                  <span class='text-gray-500'>Geen rechten</span>
                {% endif %}
              </td>`;
            tbody.appendChild(tr);
          });
          totalBooks.textContent=books.length;
          totalPriceEl.textContent=formatCurrency(sumPrice);
          totalPagesEl.textContent=sumPages;

          if(books.length===1){
            clearTimeout(coverDebounceTimeout);
            coverDebounceTimeout=setTimeout(()=>fetchCover(books[0].titel, books[0].isbn), 500);
          } else { coverSection.classList.add('hidden'); }
        })
        .catch(()=>showFlashMessage('Fout bij zoeken.','error'));
    }

    inputs.forEach(input=> input.addEventListener('input', ()=>{ clearTimeout(debounceTimeout); debounceTimeout=setTimeout(updateBooks, 300); }));

    searchForm.addEventListener('submit', (e)=>{
      if (e.submitter && document.getElementById('form_action').value === 'search') {
        e.preventDefault();
        const fd=new FormData(searchForm);
        fetchCover((fd.get('titel')||'').trim(), (fd.get('isbn')||'').trim());
        updateBooks();
      }
    });
  </script>
</body>
</html>