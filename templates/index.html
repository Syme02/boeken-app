<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Boeken Applicatie</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col">
  <!-- Container -->
  <div class="container mx-auto max-w-7xl p-4 flex flex-col flex-1">
    <!-- Titel -->
    <h1 class="text-3xl font-extrabold text-center text-gray-900 mb-6">Boeken Applicatie</h1>

    <!-- Tabs -->
    <div class="flex space-x-2 mb-6 border-b">
      <a href="{{ url_for('index') }}" class="px-4 py-2 rounded-t-lg bg-white border border-b-0 shadow-sm text-blue-600 font-medium">Boeken Zoeken</a>
      <a href="{{ url_for('statistics') }}" class="px-4 py-2 rounded-t-lg text-gray-600 hover:text-blue-600">Grafieken</a>
      <a href="{{ url_for('settings') }}" class="px-4 py-2 rounded-t-lg text-gray-600 hover:text-blue-600">Instellingen</a>
    </div>

    <!-- Content -->
    <div class="flex-1 bg-white rounded-xl shadow-sm p-6">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="mb-4 p-3 rounded-lg text-white shadow-md
              {% if category=='success' %} bg-green-500 {% elif category=='error' %} bg-red-500 {% else %} bg-blue-500 {% endif %}">
              {{ message }}
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <!-- Zoeksectie -->
      <h2 class="text-2xl font-bold mb-4">Zoeken</h2>

      <!-- Boek toevoegen form -->
      <div id="addBookForm" class="hidden mb-6">
        <h3 class="text-lg font-semibold mb-3">Boek Toevoegen</h3>
        <form id="addBookFormSubmit" method="POST" class="space-y-4">
          <input type="hidden" name="action" value="add_book">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for field in ['titel', 'auteur_voornaam', 'auteur_achternaam', 'genre', 'prijs', 'paginas', 'bindwijze', 'edition', 'isbn', 'reeks_nr', 'uitgeverij', 'serie', 'staat', 'taal', 'gesigneerd', 'gelezen'] %}
              <div>
                <label for="add_{{ field }}" class="block text-sm font-medium text-gray-700">{{ field.replace('_', ' ').title() }}</label>
                <input type="text" id="add_{{ field }}" name="add_{{ field }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500">
              </div>
            {% endfor %}
          </div>
          <div class="flex space-x-3">
            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Toevoegen</button>
            <button type="button" id="cancelAddBook" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600">Annuleren</button>
          </div>
        </form>
      </div>

      <!-- Boekkaft -->
      <div id="coverSection" class="hidden mb-6">
        <h3 class="text-lg font-semibold mb-2">Boekkaft</h3>
        <img id="coverImage" src="" alt="Boekkaft" class="max-w-xs rounded shadow-md">
      </div>

      <!-- Zoekformulier -->
      <form id="searchForm" method="POST" class="mb-6">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {% for field in ['titel', 'auteur_voornaam', 'auteur_achternaam', 'genre', 'uitgeverij', 'isbn', 'serie', 'staat', 'taal', 'gesigneerd', 'gelezen', 'bindwijze', 'edition'] %}
            <div>
              <label for="{{ field }}" class="block text-sm font-medium text-gray-700">{{ field.replace('_', ' ').title() }}</label>
              <input type="text" id="{{ field }}" name="{{ field }}" value="{{ filters[field] if field in filters else '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>
          {% endfor %}
        </div>
        <div class="flex space-x-3 mt-4">
          <button type="submit" name="action" value="search" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Zoeken</button>
          <button type="button" id="addBookButton" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Boek Toevoegen</button>
        </div>
      </form>

      <!-- Overzicht -->
      <h2 class="text-2xl font-bold mb-4">Boeken</h2>
      <p class="mb-4 text-sm text-gray-600">Totaal aantal boeken: <span id="totalBooks">{{ books | length }}</span> | Totaalprijs: €{{ total_price | round(2) }} | Totaal aantal pagina's: {{ total_pages }}</p>

      <!-- Tabel -->
      <div class="overflow-x-auto border rounded-lg shadow-sm">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-blue-600 text-white sticky top-0">
            <tr>
              <th class="px-3 py-2 text-left text-sm font-semibold">Nr</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">Titel</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">Auteur</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">Genre</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">Prijs (€)</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">Pagina's</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">Bindwijze</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">Editie</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">ISBN</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">Reeks Nr</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">Uitgeverij</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">Serie</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">Staat</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">Taal</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">Gesigneerd</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">Gelezen</th>
              <th class="px-3 py-2 text-left text-sm font-semibold">Acties</th>
            </tr>
          </thead>
          <tbody id="booksTable" class="divide-y divide-gray-100">
            {% for book in books %}
              <tr class="{{ 'bg-gray-100' if loop.index % 2 == 0 else 'bg-white' }}">
                <td class="px-3 py-2 text-sm">{{ loop.index }}</td>
                <td class="px-3 py-2 text-sm">{{ book[1] }}</td>
                <td class="px-3 py-2 text-sm">{{ book[2] }} {{ book[3] }}</td>
                <td class="px-3 py-2 text-sm">{{ book[4] }}</td>
                <td class="px-3 py-2 text-sm">{{ book[5] | round(2) }}</td>
                <td class="px-3 py-2 text-sm">{{ book[6] }}</td>
                <td class="px-3 py-2 text-sm">{{ book[7] }}</td>
                <td class="px-3 py-2 text-sm">{{ book[8] }}</td>
                <td class="px-3 py-2 text-sm">{{ book[9] }}</td>
                <td class="px-3 py-2 text-sm">{{ book[10] }}</td>
                <td class="px-3 py-2 text-sm">{{ book[11] }}</td>
                <td class="px-3 py-2 text-sm">{{ book[12] }}</td>
                <td class="px-3 py-2 text-sm">{{ book[13] }}</td>
                <td class="px-3 py-2 text-sm">{{ book[14] }}</td>
                <td class="px-3 py-2 text-sm">{{ book[15] }}</td>
                <td class="px-3 py-2 text-sm">{{ book[16] }}</td>
                <td class="px-3 py-2 text-sm">
                  <a href="{{ url_for('edit_book', book_id=book[0]) }}" class="text-blue-600 hover:underline">Bewerken</a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <p class="text-center mt-6 text-gray-500 italic">Versie 1.4.7</p>
  </div>

  <!-- Scripts (onveranderd, alleen verplaatst naar einde) -->
  <script>
    const searchForm = document.getElementById('searchForm');
    const inputs = searchForm.querySelectorAll('input');
    const addBookButton = document.getElementById('addBookButton');
    const addBookForm = document.getElementById('addBookForm');
    const addBookFormSubmit = document.getElementById('addBookFormSubmit');
    const cancelAddBook = document.getElementById('cancelAddBook');
    const coverSection = document.getElementById('coverSection');
    const coverImage = document.getElementById('coverImage');
    const totalBooks = document.getElementById('totalBooks');
    let debounceTimeout;
    let coverDebounceTimeout;

    addBookButton.addEventListener('click', () => addBookForm.classList.toggle('hidden'));
    cancelAddBook.addEventListener('click', () => { addBookForm.classList.add('hidden'); addBookFormSubmit.reset(); });

    function showFlashMessage(message, category) {
      const flashContainer = document.querySelector('.flash-container') || document.createElement('div');
      flashContainer.className = 'flash-container';
      const flashMessage = document.createElement('div');
      flashMessage.className = `mb-4 p-3 rounded-lg text-white shadow-md ${category==='success'?'bg-green-500':category==='error'?'bg-red-500':'bg-blue-500'}`;
      flashMessage.textContent = message;
      flashContainer.appendChild(flashMessage);
      searchForm.insertAdjacentElement('beforebegin', flashContainer);
      setTimeout(() => flashMessage.remove(), 5000);
    }

    function fetchCover(title, isbn) {
      if (!title && !isbn) { coverSection.classList.add('hidden'); return; }
      fetch('/fetch_cover', { method:'POST', body:new URLSearchParams({ title, isbn }) })
      .then(r=>r.json()).then(data=>{
        showFlashMessage(data.message, data.category);
        if (data.cover_url) { coverImage.src = data.cover_url; coverSection.classList.remove('hidden'); }
        else coverSection.classList.add('hidden');
      }).catch(()=> showFlashMessage('Fout bij ophalen boekkaft.','error'));
    }

    function updateBooks() {
      const formData={}; inputs.forEach(input=>{ if(input.value.trim()) formData[input.name]=input.value.trim(); });
      fetch('/search',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(formData)})
      .then(r=>r.json()).then(books=>{
        const tbody=document.getElementById('booksTable'); tbody.innerHTML='';
        books.forEach((book,i)=>{
          const tr=document.createElement('tr');
          tr.className=i%2===0?'bg-gray-100':'bg-white';
          tr.innerHTML=`<td class='px-3 py-2 text-sm'>${i+1}</td>
            <td class='px-3 py-2 text-sm'>${book.titel}</td>
            <td class='px-3 py-2 text-sm'>${book.auteur_voornaam} ${book.auteur_achternaam}</td>
            <td class='px-3 py-2 text-sm'>${book.genre}</td>
            <td class='px-3 py-2 text-sm'>${book.prijs.toFixed(2)}</td>
            <td class='px-3 py-2 text-sm'>${book.paginas}</td>
            <td class='px-3 py-2 text-sm'>${book.bindwijze}</td>
            <td class='px-3 py-2 text-sm'>${book.edition}</td>
            <td class='px-3 py-2 text-sm'>${book.isbn}</td>
            <td class='px-3 py-2 text-sm'>${book.reeks_nr}</td>
            <td class='px-3 py-2 text-sm'>${book.uitgeverij}</td>
            <td class='px-3 py-2 text-sm'>${book.serie}</td>
            <td class='px-3 py-2 text-sm'>${book.staat}</td>
            <td class='px-3 py-2 text-sm'>${book.taal}</td>
            <td class='px-3 py-2 text-sm'>${book.gesigneerd}</td>
            <td class='px-3 py-2 text-sm'>${book.gelezen}</td>
            <td class='px-3 py-2 text-sm'><a href='/edit/${book.id}' class='text-blue-600 hover:underline'>Bewerken</a></td>`;
          tbody.appendChild(tr);
        });
        totalBooks.textContent=books.length;
        if(books.length===1){ clearTimeout(coverDebounceTimeout); coverDebounceTimeout=setTimeout(()=>fetchCover(books[0].titel,books[0].isbn),500);} else coverSection.classList.add('hidden');
      }).catch(()=>showFlashMessage('Fout bij zoeken.','error'));
    }

    inputs.forEach(input=>input.addEventListener('input',()=>{clearTimeout(debounceTimeout); debounceTimeout=setTimeout(updateBooks,300);}));

    searchForm.addEventListener('submit',e=>{
      if(e.submitter.value==='search'){ e.preventDefault(); const fd=new FormData(searchForm); fetchCover(fd.get('titel')?.trim(), fd.get('isbn')?.trim()); updateBooks(); }
    });
  </script>
</body>
</html>
