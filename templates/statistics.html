{% extends "base.html" %}

{% block title %}Statistieken - Boeken Applicatie{% endblock %}

{% block content %}
  {% if fun_facts %}
  <div class="card p-4 mb-6 rounded-xl shadow-md">
    <h3 class="font-bold mb-2">üìö Fun Fact</h3>
    <p id="fun-fact-text" class="italic"></p>
  </div>
  {% endif %}

  <div class="card rounded-xl shadow-sm p-6 flex-1 mb-6">
    <h2 class="text-2xl font-bold mb-4">Statistieken</h2>

    {% if charts %}
      <div class="mb-6">
        <label for="chart-select" class="block text-sm font-medium mb-2">Kies een grafiek:</label>
        <select id="chart-select" onchange="showChart(this.value)" class="select-custom w-full md:w-1/3">
          <option value="">-- Selecteer een grafiek --</option>
          {% for chart_name in charts.keys() %}
            <option value="{{ chart_name }}">{{ chart_name.replace('_', ' ').title() }}</option>
          {% endfor %}
        </select>

      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        {% for chart_name, chart_data in charts.items() %}
          <div id="{{ chart_name }}-container" class="chart-container card p-4 rounded-xl shadow-sm" style="display: none;">
            <canvas id="{{ chart_name }}-chart"></canvas>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="p-4 rounded-lg shadow-md" style="background-color: var(--border-color); color: var(--text-color);">
        Geen statistieken beschikbaar. Voeg boeken toe om grafieken te zien.
      </div>
    {% endif %}
  </div>

  <div class="card p-4 mb-6 rounded-xl shadow-md">
    <h3 class="font-bold mb-2">üìç Boeken over Europa</h3>
    <div id="map" style="height: 500px; border-radius: 0.75rem;"></div>
  </div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
  // Debug logs
  console.log('Charts:', {{ charts | tojson | safe }});
  console.log('Fun facts:', {{ fun_facts | tojson | safe }});
  console.log('Location coords:', {{ location_coords | tojson | safe }});

  // Charts
  const chartInstances = {};
  {% for chart_name, chart_data in charts.items() %}
    if ({{ chart_data.labels | tojson | safe }}.length > 0) {
      chartInstances['{{ chart_name }}'] = new Chart(document.getElementById('{{ chart_name }}-chart').getContext('2d'), {
        type: '{{ 'pie' if chart_name in ['genre','gelezen','taal','land'] else 'bar' }}',
        data: {
          labels: {{ chart_data.labels | tojson | safe }},
          datasets: [{
            label: '{{ chart_name.replace('_',' ').title() }}',
            data: {{ chart_data.data | tojson | safe }},
            backgroundColor: [
              '#FF6384','#36A2EB','#FFCE56','#4BC0C0','#9966FF',
              '#FF9F40','#FF5733','#C70039','#900C3F','#581845'
            ],
            borderColor: '{{ settings.color }}',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { labels: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-color') } },
            title: { display: true, text: '{{ chart_name.replace("_"," ").title() }} Verdeling', color: getComputedStyle(document.documentElement).getPropertyValue('--text-color') }
          },
          scales: {
            x: { ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-color') }, grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--border-color') } },
            y: { ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-color') }, grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--border-color') } }
          }
        }
      });
    } else {
      document.getElementById('{{ chart_name }}-container').innerHTML = '<p class="text-center text-red-500">Geen data beschikbaar voor {{ chart_name.replace("_"," ").title() }}.</p>';
    }
  {% endfor %}

  function showChart(chartName) {
    document.querySelectorAll('.chart-container').forEach(c => {
      c.style.display = c.id === chartName + '-container' ? 'block' : 'none';
    });
  }

  // Standaard de eerste grafiek tonen
  const select = document.getElementById('chart-select');
  if (select && select.options.length > 1) {
    select.value = select.options[1].value;
    showChart(select.value);
  }

  // Fun facts
  const funFacts = {{ fun_facts | tojson | safe }};
  let currentFact = 0;
  const factElement = document.getElementById("fun-fact-text");
  if (funFacts.length > 0) {
    function showNextFact() {
      factElement.textContent = funFacts[currentFact];
      currentFact = (currentFact + 1) % funFacts.length;
    }
    showNextFact();
    setInterval(showNextFact, 7000);
  } else {
    factElement.textContent = 'Geen fun facts beschikbaar.';
  }

  // Map
  const locationData = {{ charts.get('land', {'labels': [], 'data': []}) | tojson | safe }};
  const locationCoords = {{ location_coords | tojson | safe }} || {};

  const map = L.map('map').setView([50.85, 4.35], 4);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18, attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

  if (locationData.labels.length === 0 || Object.keys(locationCoords).length === 0) {
    document.getElementById('map').innerHTML = '<p class="text-center text-red-500">Geen aankooplocaties beschikbaar. Voeg landinformatie toe aan boeken.</p>';
  } else {
    const bounds = [];
    for (let i = 0; i < locationData.labels.length; i++) {
      const loc = locationData.labels[i];
      const count = locationData.data[i];
      const coords = locationCoords[loc];
      if (coords) {
        L.circleMarker([coords[0], coords[1]], { radius: 5 + count*2, color: '#ff0000', fillOpacity: 0.6 })
          .bindPopup(`${loc}: ${count} boeken`).addTo(map);
        bounds.push([coords[0], coords[1]]);
      }
    }
    if (bounds.length > 0) map.fitBounds(bounds, { padding: [50,50] });
  }
</script>
{% endblock %}
